{% extends "base.html" %}
{% block content %}
<style>
  body {
    background-image: none !important;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364) !important;
    color: #f1f1f1;
  }
</style>

<style>
  .chatbot-box {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    padding: 20px;
  }
  .chat-window {
    background: #fefefe;
    border-radius: 15px;
    border: 1px solid #ddd;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
  }
  .bot-message {
    background: #eef3ff;
    color: #1e3c72;
    padding: 10px 14px;
    border-radius: 12px;
    display: inline-block;
    max-width: 80%;
  }
  .user-message {
    background: #d1ffd6;
    color: #055c1f;
    padding: 10px 14px;
    border-radius: 12px;
    display: inline-block;
    max-width: 80%;
    text-align: right;
    float: none;
    clear: both;
  }
  #chat-input {
    border-radius: 12px;
    border: 1px solid #ccc;
    padding: 10px;
  }
  .btn-primary {
    border-radius: 12px;
    font-weight: bold;
    padding: 10px 20px;
  }
  .btn-warning {
    border-radius: 12px;
    font-weight: bold;
  }
  .description-box {
    border-radius: 20px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  }
</style>

<div class="guidebot-container container py-5">

  <!-- Description Section -->
  <div class="description-box text-center p-5 mb-5" 
       style="background: linear-gradient(135deg, #1e3c72, #2a5298); color: #fff;">
    {% if request.args.get('lang') == 'en' %}
      <h2 class="mb-3 fw-bold" style="font-size: 2rem;">ğŸ¤– GuideBot â€“ Your Conflict Assistant</h2>
      <p class="lead">
        GuideBot helps you <strong>verify news</strong>, get <strong>safety tips</strong>, 
        and <strong>make informed decisions</strong> during Sudanâ€™s conflict.
      </p>
    {% else %}
      <h2 class="mb-3 fw-bold" style="font-size: 2rem;">ğŸ¤– Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª â€“ Ù…Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª</h2>
      <p class="lead">
        ÙŠØ³Ø§Ø¹Ø¯Ùƒ GuideBot Ø¹Ù„Ù‰ <strong>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</strong>ØŒ 
        Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ <strong>Ù†ØµØ§Ø¦Ø­ Ø£Ù…Ø§Ù†</strong>, 
        ÙˆØ§ØªØ®Ø§Ø° <strong>Ù‚Ø±Ø§Ø±Ø§Øª ÙˆØ§Ø¹ÙŠØ©</strong> Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø²Ø§Ø¹.
      </p>
    {% endif %}
  </div>

  <!-- Chatbot Box -->
  <div class="chatbot-box mx-auto" style="max-width: 800px;">
    <div class="chat-window p-3 mb-3" id="chat-window" style="height: 380px; overflow-y: auto;">
      <div class="bot-message mb-3">
        {% if request.args.get('lang') == 'en' %}
          ğŸ‘‹ Hello! I can verify Sudan news, give you safety tips, or help with decision support.
        {% else %}
          ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø¨Ø§Ø±ØŒ Ø¥Ø¹Ø·Ø§Ø¤Ùƒ Ù†ØµØ§Ø¦Ø­ Ø£Ù…Ø§Ù†ØŒ Ø£Ùˆ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø¯Ø¹Ù… Ø§Ù„Ù‚Ø±Ø§Ø±.
        {% endif %}
      </div>
    </div>

    <!-- Safety Tip Button -->
    <div class="chat-options mt-3 text-center">
      {% if request.args.get('lang') == 'en' %}
        <button class="btn btn-warning shadow-sm fw-bold" onclick="showSafetyTip()">ğŸ›¡ Safety Tips</button>
      {% else %}
        <button class="btn btn-warning shadow-sm fw-bold" onclick="showSafetyTip()">ğŸ›¡ Ù†ØµØ§Ø¦Ø­ Ø£Ù…Ø§Ù†</button>
      {% endif %}
    </div>

    <!-- Input -->
    <div class="mt-3 d-flex">
      <input id="chat-input" class="form-control me-2"
             placeholder="{{ 'Type your question...' if request.args.get('lang') == 'en' else 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ...' }}">
      <button id="send-btn" class="btn btn-primary">
        {{ 'Send' if request.args.get('lang') == 'en' else 'Ø¥Ø±Ø³Ø§Ù„' }}
      </button>
    </div>
  </div>
</div>

<!-- âœ… Load axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- âœ… Chat logic -->
<script>
  const LANG = "{{ request.args.get('lang', 'en') }}";
  const chatWindow = document.getElementById("chat-window");
  const inputEl = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  const safetyTips = LANG === 'ar'
    ? [
        "ğŸ“ Ø§Ø¨Ù‚Ù Ø¨Ø¹ÙŠØ¯Ù‹Ø§ Ø¹Ù† Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Ø²Ø§Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.",
        "ğŸš° Ø§Ø­Ø±Øµ Ø¹Ù„Ù‰ ØªØ®Ø²ÙŠÙ† Ù…ÙŠØ§Ù‡ Ø§Ù„Ø´Ø±Ø¨ Ø§Ù„Ù†Ù‚ÙŠØ©.",
        "ğŸ“ Ø§Ø­ØªÙØ¸ Ø¨Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙŠ Ù…ØªÙ†Ø§ÙˆÙ„ Ø§Ù„ÙŠØ¯.",
        "ğŸ§° Ø¬Ù‡Ù‘Ø² Ø­Ù‚ÙŠØ¨Ø© Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø£ÙˆÙ„ÙŠØ© Ø¨Ø³ÙŠØ·Ø©.",
        "ğŸ”‹ Ø§Ø­ØªÙØ¸ Ø¨Ù…ØµØ¯Ø± Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø§Ù‚Ø© Ù…Ø«Ù„ Ø¨Ù†Ùƒ Ø·Ø§Ù‚Ø©."
      ]
    : [
        "ğŸ“ Stay away from active conflict zones.",
        "ğŸš° Keep clean drinking water stored.",
        "ğŸ“ Always keep emergency numbers accessible.",
        "ğŸ§° Prepare a basic first aid kit.",
        "ğŸ”‹ Keep a backup power source like a power bank."
      ];
  let tipIndex = 0;

  function showSafetyTip() {
    if (tipIndex < safetyTips.length) {
      addMessage("bot-message", safetyTips[tipIndex]);
      tipIndex++;
    } else {
      addMessage("bot-message", LANG === 'ar' ? "âœ… Ø§Ù†ØªÙ‡Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµØ§Ø¦Ø­." : "âœ… No more tips available.");
    }
  }

  function addMessage(cssClass, html) {
    const div = document.createElement("div");
    div.className = cssClass + " mb-2";
    div.innerHTML = html;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    return div;
  }

  function escapeHtml(s) {
    const p = document.createElement('p');
    p.innerText = s;
    return p.innerHTML;
  }

  async function sendToBot(message) {
    if (!message) return;
    addMessage("user-message", escapeHtml(message));

    const processing = addMessage("bot-message", LANG === 'ar' ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©..." : "Processing...");

    try {
      const res = await axios.post("/api/chat", { message, lang: LANG, intent: "auto" });
      processing.remove();
      addMessage("bot-message", escapeHtml(res.data.reply || (LANG === 'ar' ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø©" : "No reply")));
    } catch (e) {
      processing.remove();
      addMessage("bot-message", LANG === 'ar' ? "âš  Ø®Ø·Ø£: ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…." : "âš  Error: Could not connect to server.");
    }
  }

  function sendText() {
    const msg = (inputEl.value || "").trim();
    if (!msg) return;
    sendToBot(msg);
    inputEl.value = "";
  }

  // âœ… Hook button + Enter
  sendBtn.addEventListener("click", sendText);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendText();
    }
  });
</script>
{% endblock %}
