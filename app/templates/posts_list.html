{% extends "base.html" %}
{% block content %}

<!-- Background wrapper -->
<section class="py-5" style="background: linear-gradient(135deg, #2c3e50, #34495e, #2c3e50); min-height: 100vh;">
  <div class="container" style="max-width: 850px;">

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4 text-white">
      <h2 class="fw-bold m-0">
        {% if lang == 'en' %}Latest Stories{% else %}أحدث المنشورات{% endif %}
      </h2>
      <a class="btn btn-gradient px-4 rounded-pill shadow-sm"
         href="{{ url_for('main.post', lang=lang) if session.get('user_id') else url_for('main.login', lang=lang) }}">
        <i class="bi bi-plus-circle me-2"></i>
        {% if lang == 'en' %}Share a Post{% else %}شارك منشورك{% endif %}
      </a>
    </div>

    <!-- Filter Section -->
    <div class="card shadow-sm border-0 rounded-4 mb-4 p-3" style="background: #f8f9fa; position: relative;">
      <div class="d-flex flex-wrap gap-2">
        
        <!-- Filter by Type -->
        <div class="dropdown">
          <button class="btn btn-outline-primary rounded-pill px-3 dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-tags-fill me-1"></i> 
            {% if lang == 'en' %}Type{% else %}النوع{% endif %}
          </button>
          <ul class="dropdown-menu dropdown-menu-light shadow-sm">
            {% for t in posts|map(attribute='misinfo_type')|unique %}
              <li><a class="dropdown-item" href="?filter=type&value={{ t }}">{{ t }}</a></li>
            {% endfor %}
          </ul>
        </div>

        <!-- Filter by Danger -->
        <div class="dropdown">
          <button class="btn btn-outline-danger rounded-pill px-3 dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> 
            {% if lang == 'en' %}Decision Danger{% else %}خطورةالقرار{% endif %}
          </button>
          <ul class="dropdown-menu dropdown-menu-light shadow-sm">
            {% for d in posts|map(attribute='danger_level')|unique %}
              <li><a class="dropdown-item" href="?filter=danger&value={{ d }}">{{ d }}</a></li>
            {% endfor %}
          </ul>
        </div>

        <!-- Filter by State -->
        <div class="dropdown">
          <button class="btn btn-outline-success rounded-pill px-3 dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-geo-alt-fill me-1"></i> 
            {% if lang == 'en' %}State{% else %}الولاية{% endif %}
          </button>
          <ul class="dropdown-menu dropdown-menu-light shadow-sm">
            {% for s in posts|map(attribute='state')|unique %}
              <li><a class="dropdown-item" href="?filter=state&value={{ s }}">{{ s }}</a></li>
            {% endfor %}
          </ul>
        </div>

        <!-- Filter by Owner -->
        <a class="btn btn-outline-dark rounded-pill px-3" href="?filter=owner&value=me">
          <i class="bi bi-person-circle me-1"></i>
          {% if lang == 'en' %}My Posts{% else %}منشوراتي{% endif %}
        </a>

        <!-- Clear Filters -->
        <a class="btn btn-outline-secondary rounded-pill px-3" href="{{ url_for('main.posts_list', lang=lang) }}">
          <i class="bi bi-x-circle me-1"></i>
          {% if lang == 'en' %}Clear{% else %}إلغاء التصفية{% endif %}
        </a>

      </div>
    </div>

    {% if not posts %}
      <div class="card shadow-sm border-0 rounded-4" style="background: #fff;">
        <div class="card-body text-center py-5">
          <i class="bi bi-chat-left-text text-secondary fs-1 mb-3"></i>
          <p class="text-muted mb-2 fs-5">
            {% if lang == 'en' %}No stories yet.{% else %}لا توجد قصص حتى الآن.{% endif %}
          </p>
          <a class="btn btn-outline-primary px-4 rounded-pill shadow-sm"
             href="{{ url_for('main.post', lang=lang) if session.get('user_id') else url_for('main.login', lang=lang) }}">
            {% if lang == 'en' %}Be the first to share{% else %}كن أول من يشارك{% endif %}
          </a>
        </div>
      </div>
    {% endif %}

    {% for post in posts %}
      <div class="card shadow-sm mb-4 border-0 rounded-4"
           style="background: #fff; transition: 0.2s; border-left: 6px solid #0d6efd;">
        <div class="card-body p-4">

          <!-- Post Title -->
          <h4 class="fw-bold text-primary mb-3">
            {{ post.misinfo_type }}
            {% if post.followup %}
              <span class="text-dark fw-normal">– {{ post.followup }}</span>
            {% endif %}
          </h4>

          <!-- Meta Info -->
          <div class="d-flex flex-wrap align-items-center small text-muted mb-3 gap-3">
            <span class="d-flex align-items-center">
              <i class="bi bi-geo-alt-fill text-danger me-1"></i>
              {{ post.state }}{% if post.locality %} – {{ post.locality }}{% endif %}
            </span>
            <span class="d-flex align-items-center">
              <i class="bi bi-exclamation-triangle-fill me-1 
                 {% if post.danger_level == 'High' %}text-danger{% elif post.danger_level == 'Medium' %}text-warning{% else %}text-success{% endif %}">
              </i>
              {{ post.danger_level }}
            </span>
            <span class="d-flex align-items-center">
              <i class="bi bi-clock text-secondary me-1"></i>
              {{ post.created_at.strftime('%b %d, %Y %H:%M') if post.created_at }}
            </span>
          </div>

          <!-- Post Content -->
          <p class="mb-4 fs-6 text-dark" style="line-height: 1.7;">
            {{ post.content }}
          </p>

          <!-- Media Section -->
          {% if post.media_items %}
            <div class="row g-3">
              {% for m in post.media_items %}
                {% if m.media_type == 'image' %}
                  <div class="col-6 col-md-4">
                    <img src="{{ url_for('main.uploaded_file', filename=m.filename) }}"
                         alt="post image"
                         class="img-fluid rounded shadow-sm border hover-zoom">
                  </div>
                {% elif m.media_type == 'audio' %}
                  <div class="col-12">
                    <audio controls class="w-100 rounded shadow-sm">
                      <source src="{{ url_for('main.uploaded_file', filename=m.filename) }}" type="audio/mpeg">
                      Your browser does not support the audio tag.
                    </audio>
                  </div>
                {% elif m.media_type == 'video' %}
                  <div class="col-12">
                    <video controls class="w-100 rounded shadow-sm border">
                      <source src="{{ url_for('main.uploaded_file', filename=m.filename) }}" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
          {% if session.get('user_id') == post.user_id %}
  <div class="mt-3 d-flex gap-2">
    <a href="{{ url_for('main.edit_post', post_id=post.id) }}" class="btn btn-warning btn-sm">
      ✏ Edit
    </a>
    <form action="{{ url_for('main.delete_post', post_id=post.id) }}" method="POST" style="display:inline;">
      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this post?');">
        🗑 Delete
      </button>
    </form>
  </div>
{% endif %}


        </div>
      </div>
    {% endfor %}

  </div>
</section>

<style>
/* Always show vertical scrollbar → avoids shaking */
html {
  overflow-y: scroll;
}

/* Subtle hover effect for cards */
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2) !important;
}

/* Gradient button */
.btn-gradient {
  background: linear-gradient(90deg, #0d6efd, #6610f2);
  color: #fff;
  font-weight: 500;
  border: none;
}
.btn-gradient:hover {
  opacity: 0.9;
  color: #fff;
}

/* Media hover zoom */
.hover-zoom {
  transition: transform 0.3s ease;
}
.hover-zoom:hover {
  transform: scale(1.05);
}

/* Dropdown shadow & fix overlap */
.dropdown-menu {
    position: absolute;
    z-index: 2000; /* higher than cards */
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>

{% endblock %}
